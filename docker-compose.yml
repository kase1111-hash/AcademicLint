# =============================================================================
# AcademicLint Docker Compose Configuration
# =============================================================================
# Usage:
#   Development:  docker-compose up dev
#   Production:   docker-compose up api
#   Tests:        docker-compose run test
#   Linting:      docker-compose run lint
#
# Environment variables (optional):
#   ACADEMICLINT_ENV       - Environment (development/staging/production)
#   ACADEMICLINT_LEVEL     - Analysis level (relaxed/standard/strict/academic)
#   ACADEMICLINT_API_PORT  - API server port (default: 8080)
# =============================================================================

services:
  # ==========================================================================
  # Production API Server
  # ==========================================================================
  api:
    build:
      context: .
      target: api
    image: academiclint:api
    container_name: academiclint-api
    ports:
      - "${ACADEMICLINT_API_PORT:-8080}:8080"
    environment:
      - ACADEMICLINT_ENV=${ACADEMICLINT_ENV:-production}
      - ACADEMICLINT_LEVEL=${ACADEMICLINT_LEVEL:-standard}
      - ACADEMICLINT_API_HOST=0.0.0.0
      - ACADEMICLINT_API_PORT=8080
    volumes:
      - ./config:/app/config:ro
      - model-cache:/home/academiclint/.cache/academiclint
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ==========================================================================
  # Development Environment
  # ==========================================================================
  dev:
    build:
      context: .
      target: development
    image: academiclint:dev
    container_name: academiclint-dev
    ports:
      - "${ACADEMICLINT_API_PORT:-8080}:8080"
    environment:
      - ACADEMICLINT_ENV=development
      - ACADEMICLINT_LEVEL=${ACADEMICLINT_LEVEL:-standard}
      - PYTHONDONTWRITEBYTECODE=1
    volumes:
      # Mount source for live reloading
      - ./src:/app/src
      - ./tests:/app/tests
      - ./config:/app/config:ro
      - model-cache:/home/academiclint/.cache/academiclint
    command: >
      python -m academiclint.cli.main serve
      --host 0.0.0.0
      --port 8080
      --reload
    stdin_open: true
    tty: true

  # ==========================================================================
  # Test Runner
  # ==========================================================================
  test:
    build:
      context: .
      target: development
    image: academiclint:dev
    container_name: academiclint-test
    environment:
      - PYTHONDONTWRITEBYTECODE=1
    volumes:
      - ./src:/app/src:ro
      - ./tests:/app/tests:ro
      - model-cache:/home/academiclint/.cache/academiclint
    command: pytest --cov=academiclint --cov-report=term-missing -v

  # ==========================================================================
  # Linting and Type Checking
  # ==========================================================================
  lint:
    build:
      context: .
      target: development
    image: academiclint:dev
    container_name: academiclint-lint
    volumes:
      - ./src:/app/src:ro
      - ./tests:/app/tests:ro
    command: >
      sh -c "ruff check src/ tests/ &&
             ruff format --check src/ tests/ &&
             mypy src/"

# =============================================================================
# Volumes
# =============================================================================
volumes:
  model-cache:
    name: academiclint-models
